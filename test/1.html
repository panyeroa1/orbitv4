<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Player - Regional Language Support</title>
    <style>
        /* --- 1. RESET & VARIABLES --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --yt-menu-bg: rgba(28, 28, 28, 0.98);
            --caption-bg: rgba(8, 8, 8, 0.75); /* YouTube style opacity */
            --font-family: 'Roboto', Arial, sans-serif;
            --accent-color: #3ea6ff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-family); }
        
        body {
            height: 100vh; width: 100vw;
            background: var(--bg-gradient);
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            user-select: none;
        }

        /* --- 2. STARTUP OVERLAY --- */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; transition: opacity 0.4s;
        }
        .overlay.hidden { opacity: 0; pointer-events: none; }
        .start-btn {
            margin-top: 25px; padding: 12px 30px;
            background: #ff0000; color: white; border: none;
            font-size: 16px; border-radius: 2px; cursor: pointer; text-transform: uppercase;
            font-weight: 700; letter-spacing: 0.5px;
        }

        /* --- 3. CAPTION CONTAINER (2 Rows, Smaller Font) --- */
        .caption-window {
            position: absolute; 
            bottom: 100px; /* Space above controls */
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            max-width: 90%;
            pointer-events: none;
            display: none; 
            flex-direction: column;
            align-items: center;
        }
        .caption-window.active { display: flex; }

        .caption-box {
            background-color: var(--caption-bg);
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            
            /* SMALLER FONT SETTINGS */
            font-size: 20px; 
            line-height: 1.4em;
            
            text-align: center;
            text-shadow: 0 0 2px #000;
            
            /* HEIGHT LOGIC: 2 lines * 1.4em = 2.8em */
            height: 2.8em; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Force text to bottom */
        }

        .caption-content { word-wrap: break-word; }
        .interim { color: #ccc; }

        /* --- 4. CONTROLS BAR --- */
        .controls {
            width: 100%; height: 60px;
            position: absolute; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: flex-end;
            padding: 0 24px; z-index: 100;
        }
        
        .icon-btn {
            background: none; border: none;
            width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; margin-left: 10px;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }
        .icon-btn svg { fill: white; width: 24px; height: 24px; }
        
        .mic-active svg { fill: #f00; filter: drop-shadow(0 0 5px #f00); }
        .cc-active::after {
            content: ''; position: absolute;
            bottom: 8px; left: 10px; width: 20px; height: 3px;
            background: #f00; border-radius: 2px;
        }

        /* --- 5. SETTINGS MENU --- */
        .settings-menu {
            position: absolute; bottom: 70px; right: 20px;
            width: 340px; 
            max-height: 520px; 
            background: var(--yt-menu-bg);
            border-radius: 12px; padding: 8px 0;
            display: none; flex-direction: column;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 32px rgba(0,0,0,0.5);
            color: white; font-size: 14px;
            z-index: 200; overflow: hidden;
        }
        .settings-menu.open { display: flex; }
        
        .panel { display: none; width: 100%; height: 100%; flex-direction: column; }
        .panel.active { display: flex; }
        
        .menu-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 16px; cursor: pointer; min-height: 40px;
        }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        
        .panel-header {
            padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            font-size: 15px; font-weight: 500; flex-shrink: 0;
        }
        .panel-header:hover { background: rgba(255,255,255,0.1); }
        
        .scroll-area { 
            overflow-y: auto; flex: 1; padding-bottom: 10px; 
        }
        .scroll-area::-webkit-scrollbar { width: 8px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #666; border-radius: 4px; border: 2px solid #1c1c1c; }
        .scroll-area::-webkit-scrollbar-track { background: transparent; }

        .check-icon { width: 18px; height: 18px; opacity: 0; }
        .menu-item.selected .check-icon { opacity: 1; }
        .val-text { color: #aaa; font-size: 12px; display: flex; align-items: center; gap: 5px; }

    </style>
</head>
<body>

    <!-- OVERLAY -->
    <div class="overlay" id="overlay">
        <h2>YouTube Live Captions</h2>
        <p style="color:#aaa; margin-top:5px; font-size: 13px;">Region Support • 2-Row Layout • Smaller Font</p>
        <button class="start-btn" onclick="init()">Launch Player</button>
    </div>

    <!-- CAPTIONS -->
    <div class="caption-window" id="captionWindow">
        <div class="caption-box">
            <span id="captionContent" class="caption-content"></span>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
        <button class="icon-btn" id="micBtn" onclick="toggleMic()" title="Microphone Toggle">
            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </button>
        <button class="icon-btn" id="ccBtn" onclick="toggleCC()" title="Subtitles/CC">
            <svg viewBox="0 0 24 24"><path d="M19 4H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm-8 7H5v-2h6v2zm0 4H5v-2h6v2zm8 0h-6v-2h6v2zm0-4h-6v-2h6v2z"/></svg>
        </button>
        <button class="icon-btn" id="settingsBtn" onclick="toggleSettings()" title="Settings">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        </button>
    </div>

    <!-- SETTINGS MENU -->
    <div class="settings-menu" id="settingsMenu">
        
        <!-- P1: Main -->
        <div class="panel active" id="p-main">
            <div class="menu-item" onclick="nav('p-source')">
                <div style="display:flex; align-items:center; gap:10px;">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                    <span>Original Language</span>
                </div>
                <div class="val-text" id="lblSource">Auto-detect</div>
            </div>
            <div class="menu-item" onclick="nav('p-subs')">
                <div style="display:flex; align-items:center; gap:10px;">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M19 4H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm-8 7H5v-2h6v2zm0 4H5v-2h6v2zm8 0h-6v-2h6v2zm0-4h-6v-2h6v2z"/></svg>
                    <span>Subtitles/CC</span>
                </div>
                <div class="val-text" id="lblTarget">Off</div>
            </div>
        </div>

        <!-- P2: Source List -->
        <div class="panel" id="p-source">
            <div class="panel-header" onclick="nav('p-main')">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                Original Language
            </div>
            <div class="scroll-area" id="listSource"></div>
        </div>

        <!-- P3: Subtitle Options -->
        <div class="panel" id="p-subs">
            <div class="panel-header" onclick="nav('p-main')">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                Subtitles/CC
            </div>
            <div class="menu-item" id="opt-off" onclick="setTarget('Off')">
                <span>Off</span><svg class="check-icon" viewBox="0 0 24 24" fill="white"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
            </div>
            <div class="menu-item" id="opt-orig" onclick="setTarget('Original (CC)')">
                <span>Original (CC)</span><svg class="check-icon" viewBox="0 0 24 24" fill="white"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
            </div>
            <div class="menu-item" onclick="nav('p-auto')">
                <span>Auto-translate</span><div class="val-text">&gt;</div>
            </div>
        </div>

        <!-- P4: Target List -->
        <div class="panel" id="p-auto">
            <div class="panel-header" onclick="nav('p-subs')">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                Translate to
            </div>
            <div class="scroll-area" id="listTarget"></div>
        </div>

    </div>

<script>
    /* --- DATA: EXTENSIVE REGIONAL LANGUAGE LIST --- */
    const fullLanguages = [
        { name: "Afrikaans", code: "af-ZA" },
        { name: "Albanian", code: "sq-AL" },
        { name: "Amharic", code: "am-ET" },
        { name: "Arabic (Algeria)", code: "ar-DZ" },
        { name: "Arabic (Bahrain)", code: "ar-BH" },
        { name: "Arabic (Egypt)", code: "ar-EG" },
        { name: "Arabic (Iraq)", code: "ar-IQ" },
        { name: "Arabic (Jordan)", code: "ar-JO" },
        { name: "Arabic (Kuwait)", code: "ar-KW" },
        { name: "Arabic (Lebanon)", code: "ar-LB" },
        { name: "Arabic (Morocco)", code: "ar-MA" },
        { name: "Arabic (Oman)", code: "ar-OM" },
        { name: "Arabic (Qatar)", code: "ar-QA" },
        { name: "Arabic (Saudi Arabia)", code: "ar-SA" },
        { name: "Arabic (State of Palestine)", code: "ar-PS" },
        { name: "Arabic (Tunisia)", code: "ar-TN" },
        { name: "Arabic (UAE)", code: "ar-AE" },
        { name: "Armenian", code: "hy-AM" },
        { name: "Azerbaijani", code: "az-AZ" },
        { name: "Basque", code: "eu-ES" },
        { name: "Bengali (Bangladesh)", code: "bn-BD" },
        { name: "Bengali (India)", code: "bn-IN" },
        { name: "Bosnian", code: "bs-BA" },
        { name: "Bulgarian", code: "bg-BG" },
        { name: "Burmese", code: "my-MM" },
        { name: "Catalan", code: "ca-ES" },
        { name: "Cebuano", code: "ceb-PH" },
        { name: "Chinese (Cantonese)", code: "yue-Hant-HK" },
        { name: "Chinese (Mandarin, Simplified)", code: "zh-CN" },
        { name: "Chinese (Mandarin, Traditional)", code: "zh-TW" },
        { name: "Croatian", code: "hr-HR" },
        { name: "Czech", code: "cs-CZ" },
        { name: "Danish", code: "da-DK" },
        { name: "Dutch (Belgium)", code: "nl-BE" },
        { name: "Dutch (Netherlands)", code: "nl-NL" },
        { name: "English (Australia)", code: "en-AU" },
        { name: "English (Canada)", code: "en-CA" },
        { name: "English (Ghana)", code: "en-GH" },
        { name: "English (India)", code: "en-IN" },
        { name: "English (Ireland)", code: "en-IE" },
        { name: "English (Kenya)", code: "en-KE" },
        { name: "English (New Zealand)", code: "en-NZ" },
        { name: "English (Nigeria)", code: "en-NG" },
        { name: "English (Philippines)", code: "en-PH" },
        { name: "English (South Africa)", code: "en-ZA" },
        { name: "English (Tanzania)", code: "en-TZ" },
        { name: "English (United Kingdom)", code: "en-GB" },
        { name: "English (United States)", code: "en-US" },
        { name: "Estonian", code: "et-EE" },
        { name: "Filipino", code: "fil-PH" },
        { name: "Finnish", code: "fi-FI" },
        { name: "French (Belgium)", code: "fr-BE" },
        { name: "French (Canada)", code: "fr-CA" },
        { name: "French (France)", code: "fr-FR" },
        { name: "French (Switzerland)", code: "fr-CH" },
        { name: "Galician", code: "gl-ES" },
        { name: "Georgian", code: "ka-GE" },
        { name: "German (Austria)", code: "de-AT" },
        { name: "German (Germany)", code: "de-DE" },
        { name: "German (Switzerland)", code: "de-CH" },
        { name: "Greek", code: "el-GR" },
        { name: "Gujarati", code: "gu-IN" },
        { name: "Hebrew", code: "he-IL" },
        { name: "Hindi", code: "hi-IN" },
        { name: "Hungarian", code: "hu-HU" },
        { name: "Icelandic", code: "is-IS" },
        { name: "Ilocano", code: "ilo-PH" },
        { name: "Indonesian", code: "id-ID" },
        { name: "Italian (Italy)", code: "it-IT" },
        { name: "Italian (Switzerland)", code: "it-CH" },
        { name: "Japanese", code: "ja-JP" },
        { name: "Javanese", code: "jv-ID" },
        { name: "Kannada", code: "kn-IN" },
        { name: "Kazakh", code: "kk-KZ" },
        { name: "Khmer", code: "km-KH" },
        { name: "Korean", code: "ko-KR" },
        { name: "Lao", code: "lo-LA" },
        { name: "Latvian", code: "lv-LV" },
        { name: "Lithuanian", code: "lt-LT" },
        { name: "Macedonian", code: "mk-MK" },
        { name: "Malay", code: "ms-MY" },
        { name: "Malayalam", code: "ml-IN" },
        { name: "Marathi", code: "mr-IN" },
        { name: "Mongolian", code: "mn-MN" },
        { name: "Nepali", code: "ne-NP" },
        { name: "Norwegian Bokmål", code: "nb-NO" },
        { name: "Persian", code: "fa-IR" },
        { name: "Polish", code: "pl-PL" },
        { name: "Portuguese (Brazil)", code: "pt-BR" },
        { name: "Portuguese (Portugal)", code: "pt-PT" },
        { name: "Punjabi (Gurmukhi)", code: "pa-Guru-IN" },
        { name: "Romanian", code: "ro-RO" },
        { name: "Russian", code: "ru-RU" },
        { name: "Serbian", code: "sr-RS" },
        { name: "Sinhala", code: "si-LK" },
        { name: "Slovak", code: "sk-SK" },
        { name: "Slovenian", code: "sl-SI" },
        { name: "Spanish (Argentina)", code: "es-AR" },
        { name: "Spanish (Bolivia)", code: "es-BO" },
        { name: "Spanish (Chile)", code: "es-CL" },
        { name: "Spanish (Colombia)", code: "es-CO" },
        { name: "Spanish (Costa Rica)", code: "es-CR" },
        { name: "Spanish (Dominican Republic)", code: "es-DO" },
        { name: "Spanish (Ecuador)", code: "es-EC" },
        { name: "Spanish (El Salvador)", code: "es-SV" },
        { name: "Spanish (Guatemala)", code: "es-GT" },
        { name: "Spanish (Honduras)", code: "es-HN" },
        { name: "Spanish (Mexico)", code: "es-MX" },
        { name: "Spanish (Nicaragua)", code: "es-NI" },
        { name: "Spanish (Panama)", code: "es-PA" },
        { name: "Spanish (Paraguay)", code: "es-PY" },
        { name: "Spanish (Peru)", code: "es-PE" },
        { name: "Spanish (Puerto Rico)", code: "es-PR" },
        { name: "Spanish (Spain)", code: "es-ES" },
        { name: "Spanish (United States)", code: "es-US" },
        { name: "Spanish (Uruguay)", code: "es-UY" },
        { name: "Spanish (Venezuela)", code: "es-VE" },
        { name: "Sundanese", code: "su-ID" },
        { name: "Swahili (Kenya)", code: "sw-KE" },
        { name: "Swahili (Tanzania)", code: "sw-TZ" },
        { name: "Swedish", code: "sv-SE" },
        { name: "Tamil (India)", code: "ta-IN" },
        { name: "Tamil (Malaysia)", code: "ta-MY" },
        { name: "Tamil (Singapore)", code: "ta-SG" },
        { name: "Tamil (Sri Lanka)", code: "ta-LK" },
        { name: "Telugu", code: "te-IN" },
        { name: "Thai", code: "th-TH" },
        { name: "Turkish", code: "tr-TR" },
        { name: "Ukrainian", code: "uk-UA" },
        { name: "Urdu (India)", code: "ur-IN" },
        { name: "Urdu (Pakistan)", code: "ur-PK" },
        { name: "Uzbek", code: "uz-UZ" },
        { name: "Vietnamese", code: "vi-VN" },
        { name: "Zulu", code: "zu-ZA" }
    ];

    /* --- STATE --- */
    let state = {
        listening: false,
        captions: false,
        sourceCode: navigator.language || 'en-US',
        sourceName: 'Auto-detect',
        targetLang: 'Off',
        bufferText: "" // Holds the committed text
    };
    
    let recognition;

    /* --- INITIALIZATION --- */
    function init() {
        document.getElementById('overlay').classList.add('hidden');
        
        // 1. Build Source Menu
        const srcList = document.getElementById('listSource');
        // Auto-detect item
        let autoItem = createItem("Auto-detect (System)", true);
        autoItem.onclick = () => setSource('Auto-detect', navigator.language || 'en-US', autoItem);
        srcList.appendChild(autoItem);
        // Full List
        fullLanguages.forEach(l => {
            let item = createItem(l.name, false);
            item.onclick = () => setSource(l.name, l.code, item);
            srcList.appendChild(item);
        });

        // 2. Build Target Menu
        const tgtList = document.getElementById('listTarget');
        fullLanguages.forEach(l => {
            let item = createItem(l.name, false);
            item.onclick = () => setTarget(l.name);
            tgtList.appendChild(item);
        });

        // 3. Start
        setupSpeech();
    }

    function createItem(txt, sel) {
        const d = document.createElement('div');
        d.className = 'menu-item' + (sel ? ' selected' : '');
        d.innerHTML = `<span>${txt}</span><svg class="check-icon" viewBox="0 0 24 24" fill="white"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>`;
        return d;
    }

    /* --- SPEECH LOGIC --- */
    function setupSpeech() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR) return alert("Please use Chrome or Edge for Speech API support.");

        if(recognition) recognition.stop();
        recognition = new SR();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = state.sourceCode;

        recognition.onstart = () => {
            state.listening = true;
            document.getElementById('micBtn').classList.add('mic-active');
        };
        recognition.onend = () => {
            state.listening = false;
            document.getElementById('micBtn').classList.remove('mic-active');
        };
        recognition.onresult = processTranscript;
        
        recognition.start();
    }

    /* --- 2-ROW CAPTION RENDERER --- */
    function processTranscript(event) {
        if(!state.captions) return;

        let final = '', interim = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if(event.results[i].isFinal) final += event.results[i][0].transcript;
            else interim += event.results[i][0].transcript;
        }

        // Apply Fake Translation
        if(state.targetLang !== 'Off' && state.targetLang !== 'Original (CC)') {
            final = mockTranslate(final, state.targetLang);
            interim = mockTranslate(interim, state.targetLang);
        }

        updateDisplay(final, interim);
    }

    function updateDisplay(finalChunk, interimChunk) {
        const box = document.querySelector('.caption-box');
        const content = document.getElementById('captionContent');

        // Add final text to buffer
        if(finalChunk) {
            state.bufferText += (state.bufferText ? " " : "") + finalChunk;
        }

        let fullText = state.bufferText;
        
        // Render
        content.innerHTML = fullText + (interimChunk ? ` <span class="interim">${interimChunk}</span>` : "");

        // --- SCROLL / WRAP LOGIC ---
        // While content height > box height (2.8em), remove words from top
        while(box.scrollHeight > box.clientHeight) {
            // Find first space
            const idx = state.bufferText.indexOf(' ');
            if(idx > -1) {
                state.bufferText = state.bufferText.slice(idx + 1);
            } else {
                state.bufferText = ""; // Safety
            }
            // Re-render
            content.innerHTML = state.bufferText + (interimChunk ? ` <span class="interim">${interimChunk}</span>` : "");
        }
    }

    /* --- MOCK TRANSLATOR --- */
    function mockTranslate(text, lang) {
        if(!text) return "";
        return text.split(' ').map(w => {
            let clean = w.toLowerCase().replace(/[^a-z0-9]/g, '');
            if(!clean) return w;
            
            // Simple visual rules
            if(lang.includes('Spanish') || lang.includes('Portuguese')) {
                if(clean.length>3 && !/[aeiou]$/.test(clean)) return w + 'o';
            } else if(lang.includes('Filipino') || lang.includes('Cebuano') || lang.includes('Ilocano')) {
                return w.replace('c','k').replace('f','p').replace('v','b');
            } else if(lang.includes('German') || lang.includes('Dutch')) {
                if(clean.length>4) return 'ge'+w;
            }
            return w;
        }).join(' ');
    }

    /* --- NAVIGATION --- */
    function setSource(name, code, el) {
        state.sourceName = name;
        state.sourceCode = code;
        document.getElementById('lblSource').textContent = name;
        
        document.querySelectorAll('#p-source .menu-item').forEach(i => i.classList.remove('selected'));
        if(el) el.classList.add('selected');

        if(recognition) {
            recognition.stop();
            recognition.lang = code;
            setTimeout(() => { recognition.start(); }, 500);
        }
        nav('p-main');
    }

    function setTarget(name) {
        state.targetLang = name;
        document.getElementById('lblTarget').textContent = name;
        state.captions = (name !== 'Off');

        document.querySelectorAll('#p-subs .menu-item').forEach(i => i.classList.remove('selected'));
        if(name === 'Off') document.getElementById('opt-off').classList.add('selected');
        else if(name === 'Original (CC)') document.getElementById('opt-orig').classList.add('selected');
        
        updateCapUI();
        document.getElementById('settingsMenu').classList.remove('open');
    }

    function updateCapUI() {
        document.getElementById('ccBtn').classList.toggle('cc-active', state.captions);
        document.getElementById('captionWindow').classList.toggle('active', state.captions);
        if(!state.captions) {
            state.bufferText = "";
            document.getElementById('captionContent').innerHTML = "";
        }
    }

    function toggleMic() {
        if(state.listening) recognition.stop();
        else recognition.start();
    }
    
    function toggleCC() {
        if(state.captions) setTarget('Off');
        else setTarget('Original (CC)');
    }
    
    function toggleSettings() {
        const m = document.getElementById('settingsMenu');
        m.classList.toggle('open');
        if(m.classList.contains('open')) nav('p-main');
    }

    window.nav = function(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    };

</script>
</body>
</html>