<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robust YouTube Captions UI</title>
    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --yt-menu-bg: rgba(28, 28, 28, 0.95);
            --yt-text: #fff;
            --yt-text-sec: #aaa;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', Arial, sans-serif; }
        
        body {
            height: 100vh;
            width: 100vw;
            background: var(--bg-gradient);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        /* --- DEBUG STATUS (To help troubleshoot) --- */
        .debug-status {
            position: absolute;
            top: 10px;
            left: 10px;
            color: rgba(255,255,255,0.5);
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
        }

        /* --- START OVERLAY (Crucial for Permissions) --- */
        .start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .start-btn {
            padding: 15px 30px;
            background: #f00;
            color: white;
            border: none;
            font-size: 18px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        .start-overlay.hidden { display: none; }

        /* --- PLAYER UI --- */
        .player-container {
            width: 100%; height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        /* --- CAPTIONS --- */
        .caption-window {
            position: absolute;
            bottom: 100px; left: 50%;
            transform: translateX(-50%);
            background-color: rgba(8, 8, 8, 0.75);
            padding: 4px 12px;
            border-radius: 2px;
            font-size: 24px;
            text-align: center;
            color: #fff;
            pointer-events: none;
            display: none; /* Hidden until active */
            max-width: 80%;
        }
        .caption-window.active { display: inline-block; }
        .interim { color: #aaa; font-style: italic; }

        /* --- CONTROLS --- */
        .controls {
            height: 60px;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 20px;
        }
        
        .icon-btn {
            background: none; border: none;
            width: 48px; height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }
        .icon-btn svg { fill: white; width: 24px; height: 24px; }
        
        .mic-active svg { fill: #f00; }
        .cc-active::after {
            content: ''; position: absolute;
            bottom: 12px; left: 14px; width: 20px; height: 2px;
            background: #f00;
        }

        /* --- MENUS --- */
        .settings-menu {
            position: absolute;
            bottom: 70px; right: 20px;
            width: 320px;
            max-height: 400px;
            background: var(--yt-menu-bg);
            border-radius: 12px;
            padding: 8px 0;
            display: none;
            flex-direction: column;
            backdrop-filter: blur(10px);
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            color: white;
            font-size: 14px;
        }
        .settings-menu.open { display: flex; }
        
        .panel { display: none; width: 100%; height: 100%; flex-direction: column; }
        .panel.active { display: flex; }
        
        .menu-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 16px;
            cursor: pointer;
        }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        
        .panel-header {
            padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: bold;
        }
        .panel-header:hover { background: rgba(255,255,255,0.1); }
        
        .scroll-area { overflow-y: auto; flex: 1; }
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

        .check-icon { width: 16px; height: 16px; opacity: 0; }
        .menu-item.selected .check-icon { opacity: 1; }
        
        .status-txt { color: #aaa; font-size: 12px; }

    </style>
</head>
<body>

    <!-- Debug Output -->
    <div class="debug-status" id="debugStatus">Status: Waiting...</div>

    <!-- Permission Overlay -->
    <div class="start-overlay" id="startOverlay">
        <h2>YouTube Live Captions Demo</h2>
        <p style="margin-top:10px; color:#ccc;">Requires Microphone Access</p>
        <button class="start-btn" onclick="initApp()">Start Listening</button>
    </div>

    <!-- App UI -->
    <div class="player-container">
        <!-- Captions -->
        <div class="caption-window" id="captionBox">
            <span id="captionText"></span>
        </div>

        <!-- Controls -->
        <div class="controls">
            <!-- Mic -->
            <button class="icon-btn" id="micBtn" onclick="toggleMic()">
                <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            </button>
            <!-- CC -->
            <button class="icon-btn" id="ccBtn" onclick="toggleCC()">
                <svg viewBox="0 0 24 24"><path d="M19 4H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm-8 7H5v-2h6v2zm0 4H5v-2h6v2zm8 0h-6v-2h6v2zm0-4h-6v-2h6v2z"/></svg>
            </button>
            <!-- Settings -->
            <button class="icon-btn" id="settingsBtn" onclick="toggleSettings()">
                <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </button>
        </div>

        <!-- SETTINGS POPUP -->
        <div class="settings-menu" id="settingsMenu">
            
            <!-- PANEL: MAIN -->
            <div class="panel active" id="p-main">
                <!-- Source Lang -->
                <div class="menu-item" onclick="nav('p-source')">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                        <span>Source Language</span>
                    </div>
                    <div class="status-txt" id="lblSource">Auto-detect</div>
                </div>
                
                <!-- Audio Source -->
                <div class="menu-item" onclick="nav('p-device')">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                        <span>Input Device</span>
                    </div>
                    <div class="status-txt" id="lblDevice">Default</div>
                </div>

                <!-- Subtitles -->
                <div class="menu-item" onclick="nav('p-subs')">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M19 4H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm-8 7H5v-2h6v2zm0 4H5v-2h6v2zm8 0h-6v-2h6v2zm0-4h-6v-2h6v2z"/></svg>
                        <span>Subtitles/CC</span>
                    </div>
                    <div class="status-txt" id="lblTarget">Off</div>
                </div>
            </div>

            <!-- PANEL: SOURCE LANG -->
            <div class="panel" id="p-source">
                <div class="panel-header" onclick="nav('p-main')">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    Source Language
                </div>
                <div class="scroll-area" id="listSource"></div>
            </div>

            <!-- PANEL: INPUT DEVICE -->
            <div class="panel" id="p-device">
                <div class="panel-header" onclick="nav('p-main')">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    Input Device
                </div>
                <div class="scroll-area" id="listDevice"></div>
            </div>

             <!-- PANEL: SUBTITLES -->
             <div class="panel" id="p-subs">
                <div class="panel-header" onclick="nav('p-main')">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    Subtitles/CC
                </div>
                <div class="menu-item selected" id="opt-off" onclick="setTarget('off')">
                    <span>Off</span><svg class="check-icon" viewBox="0 0 24 24" fill="white"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                </div>
                <div class="menu-item" id="opt-cc" onclick="setTarget('original')">
                    <span>Original (CC)</span><svg class="check-icon" viewBox="0 0 24 24" fill="white"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                </div>
                <div class="menu-item" onclick="nav('p-trans')">
                    <span>Auto-translate</span> <span>&gt;</span>
                </div>
            </div>

            <!-- PANEL: TRANSLATE -->
            <div class="panel" id="p-trans">
                <div class="panel-header" onclick="nav('p-subs')">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    Translate to
                </div>
                <div class="scroll-area" id="listTarget"></div>
            </div>

        </div>
    </div>

<script>
    const userLocale = navigator.language || 'en-US';
    const baseLanguages = [
        { code: 'af-ZA', name: 'Afrikaans (South Africa)' },
        { code: 'am-ET', name: 'Amharic (Ethiopia)' },
        { code: 'ar-AE', name: 'Arabic (United Arab Emirates)' },
        { code: 'ar-BH', name: 'Arabic (Bahrain)' },
        { code: 'ar-DZ', name: 'Arabic (Algeria)' },
        { code: 'ar-EG', name: 'Arabic (Egypt)' },
        { code: 'ar-IQ', name: 'Arabic (Iraq)' },
        { code: 'ar-JO', name: 'Arabic (Jordan)' },
        { code: 'ar-KW', name: 'Arabic (Kuwait)' },
        { code: 'ar-LB', name: 'Arabic (Lebanon)' },
        { code: 'ar-MA', name: 'Arabic (Morocco)' },
        { code: 'ar-OM', name: 'Arabic (Oman)' },
        { code: 'ar-QA', name: 'Arabic (Qatar)' },
        { code: 'ar-SA', name: 'Arabic (Saudi Arabia)' },
        { code: 'ar-SY', name: 'Arabic (Syria)' },
        { code: 'ar-TN', name: 'Arabic (Tunisia)' },
        { code: 'ar-YE', name: 'Arabic (Yemen)' },
        { code: 'az-AZ', name: 'Azerbaijani (Azerbaijan)' },
        { code: 'bg-BG', name: 'Bulgarian (Bulgaria)' },
        { code: 'bn-BD', name: 'Bengali (Bangladesh)' },
        { code: 'bn-IN', name: 'Bengali (India)' },
        { code: 'ca-ES', name: 'Catalan (Spain)' },
        { code: 'ceb-PH', name: 'Cebuano (Philippines)' },
        { code: 'cs-CZ', name: 'Czech (Czechia)' },
        { code: 'cy-GB', name: 'Welsh (United Kingdom)' },
        { code: 'da-DK', name: 'Danish (Denmark)' },
        { code: 'de-AT', name: 'German (Austria)' },
        { code: 'de-DE', name: 'German (Germany)' },
        { code: 'de-CH', name: 'German (Switzerland)' },
        { code: 'el-GR', name: 'Greek (Greece)' },
        { code: 'en-AU', name: 'English (Australia)' },
        { code: 'en-CA', name: 'English (Canada)' },
        { code: 'en-GH', name: 'English (Ghana)' },
        { code: 'en-HK', name: 'English (Hong Kong)' },
        { code: 'en-IE', name: 'English (Ireland)' },
        { code: 'en-IN', name: 'English (India)' },
        { code: 'en-KE', name: 'English (Kenya)' },
        { code: 'en-NG', name: 'English (Nigeria)' },
        { code: 'en-NZ', name: 'English (New Zealand)' },
        { code: 'en-PH', name: 'English (Philippines)' },
        { code: 'en-SG', name: 'English (Singapore)' },
        { code: 'en-TZ', name: 'English (Tanzania)' },
        { code: 'en-GB', name: 'English (United Kingdom)' },
        { code: 'en-US', name: 'English (United States)' },
        { code: 'en-ZA', name: 'English (South Africa)' },
        { code: 'es-AR', name: 'Spanish (Argentina)' },
        { code: 'es-BO', name: 'Spanish (Bolivia)' },
        { code: 'es-CL', name: 'Spanish (Chile)' },
        { code: 'es-CO', name: 'Spanish (Colombia)' },
        { code: 'es-CR', name: 'Spanish (Costa Rica)' },
        { code: 'es-DO', name: 'Spanish (Dominican Republic)' },
        { code: 'es-EC', name: 'Spanish (Ecuador)' },
        { code: 'es-ES', name: 'Spanish (Spain)' },
        { code: 'es-GT', name: 'Spanish (Guatemala)' },
        { code: 'es-HN', name: 'Spanish (Honduras)' },
        { code: 'es-MX', name: 'Spanish (Mexico)' },
        { code: 'es-NI', name: 'Spanish (Nicaragua)' },
        { code: 'es-PA', name: 'Spanish (Panama)' },
        { code: 'es-PE', name: 'Spanish (Peru)' },
        { code: 'es-PR', name: 'Spanish (Puerto Rico)' },
        { code: 'es-PY', name: 'Spanish (Paraguay)' },
        { code: 'es-SV', name: 'Spanish (El Salvador)' },
        { code: 'es-US', name: 'Spanish (United States)' },
        { code: 'es-UY', name: 'Spanish (Uruguay)' },
        { code: 'es-VE', name: 'Spanish (Venezuela)' },
        { code: 'et-EE', name: 'Estonian (Estonia)' },
        { code: 'eu-ES', name: 'Basque (Spain)' },
        { code: 'fa-IR', name: 'Persian (Iran)' },
        { code: 'fi-FI', name: 'Finnish (Finland)' },
        { code: 'fil-PH', name: 'Filipino (Philippines)' },
        { code: 'fr-BE', name: 'French (Belgium)' },
        { code: 'fr-CA', name: 'French (Canada)' },
        { code: 'fr-CH', name: 'French (Switzerland)' },
        { code: 'fr-FR', name: 'French (France)' },
        { code: 'ga-IE', name: 'Irish (Ireland)' },
        { code: 'gl-ES', name: 'Galician (Spain)' },
        { code: 'gu-IN', name: 'Gujarati (India)' },
        { code: 'he-IL', name: 'Hebrew (Israel)' },
        { code: 'hi-IN', name: 'Hindi (India)' },
        { code: 'hr-HR', name: 'Croatian (Croatia)' },
        { code: 'hu-HU', name: 'Hungarian (Hungary)' },
        { code: 'hy-AM', name: 'Armenian (Armenia)' },
        { code: 'id-ID', name: 'Indonesian (Indonesia)' },
        { code: 'is-IS', name: 'Icelandic (Iceland)' },
        { code: 'it-CH', name: 'Italian (Switzerland)' },
        { code: 'it-IT', name: 'Italian (Italy)' },
        { code: 'ja-JP', name: 'Japanese (Japan)' },
        { code: 'jv-ID', name: 'Javanese (Indonesia)' },
        { code: 'ka-GE', name: 'Georgian (Georgia)' },
        { code: 'kk-KZ', name: 'Kazakh (Kazakhstan)' },
        { code: 'km-KH', name: 'Khmer (Cambodia)' },
        { code: 'kn-IN', name: 'Kannada (India)' },
        { code: 'ko-KR', name: 'Korean (South Korea)' },
        { code: 'ky-KG', name: 'Kyrgyz (Kyrgyzstan)' },
        { code: 'la-VA', name: 'Latin (Vatican City)' },
        { code: 'lo-LA', name: 'Lao (Laos)' },
        { code: 'lt-LT', name: 'Lithuanian (Lithuania)' },
        { code: 'lv-LV', name: 'Latvian (Latvia)' },
        { code: 'mk-MK', name: 'Macedonian (North Macedonia)' },
        { code: 'ml-IN', name: 'Malayalam (India)' },
        { code: 'mn-MN', name: 'Mongolian (Mongolia)' },
        { code: 'mr-IN', name: 'Marathi (India)' },
        { code: 'ms-MY', name: 'Malay (Malaysia)' },
        { code: 'my-MM', name: 'Burmese (Myanmar)' },
        { code: 'nb-NO', name: 'Norwegian (Norway)' },
        { code: 'ne-NP', name: 'Nepali (Nepal)' },
        { code: 'nl-BE', name: 'Dutch (Belgium)' },
        { code: 'nl-NL', name: 'Dutch (Netherlands)' },
        { code: 'pa-IN', name: 'Punjabi (India)' },
        { code: 'pa-PK', name: 'Punjabi (Pakistan)' },
        { code: 'pl-PL', name: 'Polish (Poland)' },
        { code: 'pt-BR', name: 'Portuguese (Brazil)' },
        { code: 'pt-PT', name: 'Portuguese (Portugal)' },
        { code: 'ro-RO', name: 'Romanian (Romania)' },
        { code: 'ru-RU', name: 'Russian (Russia)' },
        { code: 'si-LK', name: 'Sinhala (Sri Lanka)' },
        { code: 'sk-SK', name: 'Slovak (Slovakia)' },
        { code: 'sl-SI', name: 'Slovenian (Slovenia)' },
        { code: 'sq-AL', name: 'Albanian (Albania)' },
        { code: 'sr-RS', name: 'Serbian (Serbia)' },
        { code: 'su-ID', name: 'Sundanese (Indonesia)' },
        { code: 'sv-SE', name: 'Swedish (Sweden)' },
        { code: 'sw-KE', name: 'Swahili (Kenya)' },
        { code: 'sw-TZ', name: 'Swahili (Tanzania)' },
        { code: 'ta-IN', name: 'Tamil (India)' },
        { code: 'ta-LK', name: 'Tamil (Sri Lanka)' },
        { code: 'ta-MY', name: 'Tamil (Malaysia)' },
        { code: 'ta-SG', name: 'Tamil (Singapore)' },
        { code: 'te-IN', name: 'Telugu (India)' },
        { code: 'th-TH', name: 'Thai (Thailand)' },
        { code: 'tr-TR', name: 'Turkish (Turkey)' },
        { code: 'uk-UA', name: 'Ukrainian (Ukraine)' },
        { code: 'ur-IN', name: 'Urdu (India)' },
        { code: 'ur-PK', name: 'Urdu (Pakistan)' },
        { code: 'uz-UZ', name: 'Uzbek (Uzbekistan)' },
        { code: 'vi-VN', name: 'Vietnamese (Vietnam)' },
        { code: 'xh-ZA', name: 'Xhosa (South Africa)' },
        { code: 'yue-Hant-HK', name: 'Cantonese (Hong Kong)' },
        { code: 'zh-CN', name: 'Chinese (Mainland)' },
        { code: 'zh-HK', name: 'Chinese (Hong Kong)' },
        { code: 'zh-TW', name: 'Chinese (Taiwan)' },
        { code: 'zu-ZA', name: 'Zulu (South Africa)' },
        { code: 'ilo-PH', name: 'Ilocano (Philippines)' }
    ];
    const languageCatalog = [{ code: 'auto', name: 'Auto-detect (' + userLocale + ')', isSystem: true }, ...baseLanguages];
    const localDictionaries = {
        fil: { hello: 'kamusta', world: 'mundo', this: 'ito', is: 'ay', good: 'maganda', thanks: 'salamat', love: 'mahal', you: 'ikaw', we: 'kami', computer: 'kompyuter', language: 'wika' },
        ceb: { hello: 'kumusta', world: 'kalibutan', this: 'kini', good: 'maayo', thanks: 'salamat', love: 'gugma', you: 'ikaw', we: 'kita', computer: 'kompyuter' },
        ilo: { hello: 'kablaaw', world: 'lubong', this: 'daytoy', good: 'nasayaat', thanks: 'agyamanak', love: 'ayat', you: 'sika', we: 'dakami' },
        es: { hello: 'hola', world: 'mundo', this: 'esto', good: 'bueno', thanks: 'gracias', love: 'amor', you: 't\u00fa', we: 'nosotros', computer: 'computadora', code: 'c\u00f3digo', language: 'idioma' },
        fr: { hello: 'bonjour', world: 'monde', this: 'ceci', good: 'bon', thanks: 'merci', love: 'amour', you: 'vous', we: 'nous', computer: 'ordinateur', code: 'code', language: 'langue' },
        de: { hello: 'hallo', world: 'welt', this: 'dies', good: 'gut', thanks: 'danke', love: 'liebe', you: 'du', we: 'wir', computer: 'computer', code: 'code', language: 'sprache' },
        ja: { hello: '\u3053\u3093\u306b\u3061\u306f', world: '\u4e16\u754c', this: '\u3053\u308c', good: '\u3044\u3044', thanks: '\u3042\u308a\u304c\u3068\u3046', love: '\u611b', you: '\u3042\u306a\u305f', we: '\u308f\u305f\u3057\u305f\u3061' },
        ko: { hello: '\uc548\ub155', world: '\uc138\uacc4', this: '\uc774\uac83', good: '\uc88b\uc740', thanks: '\uace0\ub9d9\uc2b5\ub2c8\ub2e4', love: '\uc0ac\ub791', you: '\ub2f9\uc2e0', we: '\uc6b0\ub9ac' },
        zh: { hello: '\u4f60\u597d', world: '\u4e16\u754c', this: '\u8fd9', good: '\u597d', thanks: '\u8c22\u8c22', love: '\u7231', you: '\u4f60', we: '\u6211\u4eec' },
        ru: { hello: '\u043f\u0440\u0438\u0432\u0435\u0442', world: '\u043c\u0438\u0440', this: '\u044d\u0442\u043e', good: '\u0445\u043e\u0440\u043e\u0448\u043e', thanks: '\u0441\u043f\u0430\u0441\u0438\u0431\u043e', love: '\u043b\u044e\u0431\u043e\u0432\u044c', you: '\u0442\u044b', we: '\u043c\u044b' },
        pt: { hello: 'ol\u00e1', world: 'mundo', this: 'isto', good: 'bom', thanks: 'obrigado', love: 'amor', you: 'voc\u00ea', we: 'n\u00f3s', computer: 'computador' },
        it: { hello: 'ciao', world: 'mondo', this: 'questo', good: 'buono', thanks: 'grazie', love: 'amore', you: 'tu', we: 'noi', computer: 'computer' },
        hi: { hello: '\u0928\u092e\u0938\u094d\u0924\u0947', world: '\u0926\u0941\u0928\u093f\u092f\u093e', this: '\u092f\u0939', good: '\u0905\u091a\u094d\u091b\u093e', thanks: '\u0927\u0928\u094d\u092f\u0935\u093e\u0926', love: '\u092a\u094d\u092f\u093e\u0930', you: '\u0924\u0941\u092e', we: '\u0939\u092e' },
        ar: { hello: '\u0645\u0631\u062d\u0628\u0627', world: '\u0627\u0644\u0639\u0627\u0644\u0645', this: '\u0647\u0630\u0627', good: '\u062c\u064a\u062f', thanks: '\u0634\u0643\u0631\u0627', love: '\u062d\u0628', you: '\u0623\u0646\u062a', we: '\u0646\u062d\u0646' },
        tr: { hello: 'merhaba', world: 'd\u00fcnya', this: 'bu', good: 'iyi', thanks: 'te\u015fekk\u00fcrler', love: 'a\u015fk', you: 'sen', we: 'biz' },
        vi: { hello: 'xin ch\u00e0o', world: 'th\u1ebf gi\u1edbi', this: 'n\u00e0y', good: 't\u1ed1t', thanks: 'c\u1ea3m \u01a1n', love: 't\u00ecnh y\u00eau', you: 'b\u1ea1n', we: 'ch\u00fang t\u00f4i' }
    };
    const pseudoAccentSets = {
        default: { a: '\u00e1', e: '\u00e9', i: '\u00ed', o: '\u00f3', u: '\u00fa' },
        nordic: { a: '\u00e5', e: '\u00e9', i: '\u00ed', o: '\u00f8', u: '\u00fa' },
        slavic: { a: '\u0105', e: '\u0119', i: '\u012f', o: '\u00f3', u: '\u0173' },
        asian: { a: '\u3042', e: '\u3048', i: '\u3044', o: '\u304a', u: '\u3046' }
    };
    const CHECK_ICON = '<svg class="check-icon" viewBox="0 0 24 24" fill="white"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>';
    const translationCache = new Map();
    let recognition;
    const state = {
        listening: false,
        captions: false,
        sourceLang: 'auto',
        targetLang: 'off',
        previousTarget: 'original',
        audioDevices: [],
        userWantsListening: false,
        lastRenderToken: 0,
        translationWarningShown: false
    };
    const els = {
        startOverlay: document.getElementById('startOverlay'),
        debug: document.getElementById('debugStatus'),
        lblSource: document.getElementById('lblSource'),
        lblDevice: document.getElementById('lblDevice'),
        lblTarget: document.getElementById('lblTarget'),
        settingsMenu: document.getElementById('settingsMenu'),
        captionBox: document.getElementById('captionBox'),
        captionText: document.getElementById('captionText'),
        micBtn: document.getElementById('micBtn'),
        ccBtn: document.getElementById('ccBtn'),
        listSource: document.getElementById('listSource'),
        listTarget: document.getElementById('listTarget'),
        listDevice: document.getElementById('listDevice')
    };

    els.lblSource.textContent = getLanguageLabel(state.sourceLang);
    els.lblTarget.textContent = getLanguageLabel(state.targetLang);
    els.lblDevice.textContent = 'Default';

    function getRecognitionLanguage() {
        return state.sourceLang === 'auto' ? (navigator.language || 'en-US') : state.sourceLang;
    }

    async function initApp() {
        els.startOverlay.classList.add('hidden');
        log('Initializing...');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            log('ERROR: Web Speech API not supported.');
            alert('This browser does not support the Web Speech API. Please try Chrome or Edge.');
            return;
        }
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = getRecognitionLanguage();

        recognition.onstart = () => {
            state.listening = true;
            updateMicUI(true);
            log('Listening... Speak now.');
        };

        recognition.onend = () => {
            state.listening = false;
            updateMicUI(false);
            if (state.userWantsListening) {
                try {
                    recognition.start();
                } catch (err) {
                    state.userWantsListening = false;
                    log('Unable to restart microphone: ' + err.message);
                }
            } else {
                log('Microphone stopped. Click Mic to listen again.');
            }
        };

        recognition.onerror = (event) => {
            log('Error: ' + event.error);
            if (event.error === 'not-allowed') {
                alert('Microphone access blocked. Please allow it in your browser settings.');
            }
        };

        recognition.onresult = (event) => {
            let finalTranscript = '';
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const result = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += result;
                } else {
                    interimTranscript += result;
                }
            }
            if (state.captions) {
                render(finalTranscript, interimTranscript);
            }
        };

        try {
            await navigator.mediaDevices.getUserMedia({ audio: true });
            const devices = await navigator.mediaDevices.enumerateDevices();
            state.audioDevices = devices.filter((d) => d.kind === 'audioinput');
            populateDevices();
        } catch (err) {
            log('Warning: Could not enumerate microphones (' + err.message + ')');
        }

        try {
            state.userWantsListening = true;
            recognition.start();
        } catch (err) {
            log('Microphone start failed: ' + err.message);
        }
    }

    function populateLangs() {
        if (!els.listSource || !els.listTarget) return;
        els.listSource.innerHTML = '';
        els.listTarget.innerHTML = '';
        languageCatalog.forEach((lang) => {
            const srcItem = createMenuItem(lang.name, lang.code === state.sourceLang);
            srcItem.dataset.code = lang.code;
            srcItem.onclick = () => selectSourceLanguage(lang.code, lang.name);
            els.listSource.appendChild(srcItem);
            if (!lang.isSystem) {
                const tgtItem = createMenuItem(lang.name, lang.code === state.targetLang);
                tgtItem.dataset.code = lang.code;
                tgtItem.onclick = () => setTarget(lang.code);
                els.listTarget.appendChild(tgtItem);
            }
        });
    }

    function createMenuItem(label, selected) {
        const div = document.createElement('div');
        div.className = 'menu-item' + (selected ? ' selected' : '');
        div.innerHTML = '<span>' + label + '</span>' + CHECK_ICON;
        return div;
    }

    function syncSelections(container, code) {
        if (!container) return;
        container.querySelectorAll('.menu-item').forEach((item) => {
            item.classList.toggle('selected', item.dataset.code === code);
        });
    }

    function selectSourceLanguage(code, label) {
        state.sourceLang = code;
        els.lblSource.textContent = label;
        syncSelections(els.listSource, code);
        if (recognition) {
            recognition.lang = getRecognitionLanguage();
            if (state.userWantsListening) {
                recognition.stop();
                setTimeout(() => {
                    try {
                        recognition.start();
                    } catch (err) {
                        state.userWantsListening = false;
                        log('Restart failed: ' + err.message);
                    }
                }, 300);
            }
        }
        nav('p-main');
    }

    function populateDevices() {
        if (!els.listDevice) return;
        els.listDevice.innerHTML = '';
        addDeviceItem(els.listDevice, 'Default', 'default');
        state.audioDevices.forEach((device) => {
            const label = device.label || ('Microphone ' + device.deviceId.slice(0, 5));
            addDeviceItem(els.listDevice, label, device.deviceId);
        });
    }

    function addDeviceItem(list, label, id) {
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.dataset.code = id;
        div.innerHTML = '<span>' + label + '</span>' + CHECK_ICON;
        div.onclick = () => {
            els.lblDevice.textContent = label.length > 18 ? label.slice(0, 18) + '...' : label;
            alert('Note: The Web Speech API always uses the system default microphone. Switch the default input in your OS settings to change devices.');
            nav('p-main');
        };
        list.appendChild(div);
    }

    function toggleMic() {
        if (!recognition) return;
        state.userWantsListening = !state.userWantsListening;
        if (state.userWantsListening) {
            try {
                recognition.start();
            } catch (err) {
                state.userWantsListening = false;
                log('Mic start failed: ' + err.message);
            }
        } else {
            recognition.stop();
        }
    }

    function toggleCC() {
        if (state.captions) {
            setTarget('off', false);
        } else {
            const next = state.previousTarget || 'original';
            setTarget(next, false);
        }
    }

    function setTarget(code, closeMenu = true) {
        state.targetLang = code;
        if (code !== 'off') {
            state.previousTarget = code;
        }
        state.captions = code !== 'off';
        els.lblTarget.textContent = getLanguageLabel(code);
        const optOff = document.getElementById('opt-off');
        const optCc = document.getElementById('opt-cc');
        if (optOff && optCc) {
            optOff.classList.toggle('selected', code === 'off');
            optCc.classList.toggle('selected', code === 'original');
        }
        syncSelections(els.listTarget, code);
        updateCCUI();
        if (!state.captions) {
            state.lastRenderToken++;
            els.captionText.innerHTML = '';
        }
        if (closeMenu) {
            nav('p-main');
            els.settingsMenu.classList.remove('open');
        }
    }

    async function render(finalText = '', interimText = '') {
        const token = ++state.lastRenderToken;
        if (!state.captions) {
            els.captionText.innerHTML = '';
            return;
        }
        if (!finalText && !interimText) {
            els.captionText.innerHTML = '';
            return;
        }
        const needsTranslation = state.targetLang !== 'off' && state.targetLang !== 'original';
        if (!needsTranslation) {
            els.captionText.innerHTML = buildCaptionHTML(finalText, interimText);
            return;
        }
        const [translatedFinal, translatedInterim] = await Promise.all([
            translateSegment(finalText, state.targetLang),
            translateSegment(interimText, state.targetLang)
        ]);
        if (token !== state.lastRenderToken) return;
        els.captionText.innerHTML = buildCaptionHTML(translatedFinal, translatedInterim);
    }

    function buildCaptionHTML(finalText, interimText) {
        const safeFinal = escapeHTML(finalText || '');
        const safeInterim = escapeHTML(interimText || '');
        return safeFinal + ' <span class="interim">' + safeInterim + '</span>';
    }

    async function translateSegment(text, targetCode) {
        if (!text || !text.trim()) return '';
        if (targetCode === 'original' || targetCode === 'off') return text;
        const normalizedTarget = normalizeLang(targetCode);
        const normalizedSource = state.sourceLang === 'auto' ? 'auto' : normalizeLang(state.sourceLang);
        const cacheKey = normalizedSource + '|' + normalizedTarget + '::' + text;
        if (translationCache.has(cacheKey)) {
            return translationCache.get(cacheKey);
        }
        let translated = await translateViaAPI(text, normalizedSource, normalizedTarget);
        if (!translated) {
            translated = fallbackTranslate(text, normalizedTarget);
        }
        translationCache.set(cacheKey, translated);
        return translated;
    }

    async function translateViaAPI(text, sourceCode, targetCode) {
        try {
            const response = await fetch('https://libretranslate.de/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    q: text,
                    source: sourceCode === 'auto' ? 'auto' : sourceCode,
                    target: targetCode,
                    format: 'text'
                })
            });
            if (!response.ok) return null;
            const data = await response.json();
            if (data && data.translatedText) {
                return data.translatedText;
            }
        } catch (err) {
            if (!state.translationWarningShown) {
                log('Translation service unreachable. Falling back to offline mode.');
                state.translationWarningShown = true;
            }
            console.warn('Translation API error', err);
        }
        return null;
    }

    function applySimpleDictionary(text, code) {
        const dictionary = localDictionaries[code];
        if (!dictionary) return null;
        return text.split(/(\s+)/).map((segment) => {
            if (!segment.trim()) return segment;
            const stripped = segment.toLowerCase().replace(/[^a-z]/g, '');
            const replacement = dictionary[stripped];
            if (!replacement) return segment;
            return matchCase(segment, replacement);
        }).join('');
    }

    function matchCase(original, translated) {
        if (!original) return translated;
        if (original === original.toUpperCase()) return translated.toUpperCase();
        if (original[0] === original[0].toUpperCase()) {
            return translated.charAt(0).toUpperCase() + translated.slice(1);
        }
        return translated;
    }

    function fallbackTranslate(text, targetCode) {
        const normalized = normalizeLang(targetCode);
        const dictionaryResult = applySimpleDictionary(text, normalized);
        if (dictionaryResult !== null) return dictionaryResult;
        const accentKey = getAccentKey(normalized);
        const accentSet = pseudoAccentSets[accentKey] || pseudoAccentSets.default;
        return text.split('').map((char) => {
            const lower = char.toLowerCase();
            const replacement = accentSet[lower];
            if (replacement) {
                return char === lower ? replacement : replacement.toUpperCase();
            }
            return char;
        }).join('');
    }

    function getAccentKey(code) {
        if (['sv', 'nb', 'da', 'fi', 'is', 'et', 'lt', 'lv'].includes(code)) return 'nordic';
        if (['pl', 'sk', 'sl', 'cs', 'sr', 'hr', 'ru', 'uk', 'bg'].includes(code)) return 'slavic';
        if (['ja', 'ko', 'zh', 'yue', 'th', 'vi'].includes(code)) return 'asian';
        return 'default';
    }

    function normalizeLang(code) {
        if (!code) return 'en';
        return code.split('-')[0].toLowerCase();
    }

    function escapeHTML(value) {
        if (!value) return '';
        return value.replace(/[&<>]/g, (char) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[char] || char));
    }

    function getLanguageLabel(code) {
        if (code === 'off') return 'Off';
        if (code === 'original') return 'Original (CC)';
        if (code === 'auto') return 'Auto-detect (' + userLocale + ')';
        const match = languageCatalog.find((lang) => lang.code === code);
        return match ? match.name : code;
    }

    function log(message) {
        if (els.debug) {
            els.debug.innerText = 'Status: ' + message;
        }
        console.log(message);
    }

    function nav(panelId) {
        document.querySelectorAll('.panel').forEach((panel) => panel.classList.remove('active'));
        const panel = document.getElementById(panelId);
        if (panel) {
            panel.classList.add('active');
        }
    }

    function updateMicUI(isActive) {
        els.micBtn.classList.toggle('mic-active', isActive);
    }

    function updateCCUI() {
        els.ccBtn.classList.toggle('cc-active', state.captions);
        els.captionBox.classList.toggle('active', state.captions);
    }

    function toggleSettings() {
        els.settingsMenu.classList.toggle('open');
        if (els.settingsMenu.classList.contains('open')) {
            nav('p-main');
        }
    }

    populateLangs();
    updateCCUI();
</script>
</body>
</html>
